<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë­í‚¹ ì¶”ì  ë¡œì»¬ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 10px;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        #result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }
        .success {
            color: #10b981;
            font-weight: 600;
        }
        .error {
            color: #ef4444;
            font-weight: 600;
        }
        .info {
            background: #dbeafe;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #3b82f6;
        }
        .warning {
            background: #fef3c7;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #f59e0b;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        #loginSection {
            background: #fef3c7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ë¸”ë¡œê·¸ ë­í‚¹ ì¶”ì  ë¡œì»¬ í…ŒìŠ¤íŠ¸</h1>

        <div class="info">
            <strong>ğŸ’¡ í…ŒìŠ¤íŠ¸ í™˜ê²½:</strong> ë¡œì»¬ (Firebase Emulator ë˜ëŠ” ì‹¤ì œ Firebase)<br>
            <strong>ğŸ“ CORS:</strong> í•´ê²°ë¨ (Firebase Functions ì‚¬ìš©)
        </div>

        <!-- ë¡œê·¸ì¸ ì„¹ì…˜ -->
        <div id="loginSection" class="section">
            <h2>1ï¸âƒ£ ë¡œê·¸ì¸</h2>
            <p>Firebase Auth ìƒíƒœ: <span id="authStatus" class="status disconnected">ë¡œê·¸ì¸ í•„ìš”</span></p>
            <button onclick="loginTest()">í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</button>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            <div id="userInfo" style="margin-top: 10px;"></div>
        </div>

        <!-- í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
        <div class="section">
            <h2>2ï¸âƒ£ ìˆœìœ„ í™•ì¸ í…ŒìŠ¤íŠ¸</h2>

            <div class="input-group">
                <label>í‚¤ì›Œë“œ:</label>
                <input type="text" id="keyword" placeholder="ì˜ˆ: í‚¤ì›Œë“œ ë¶„ì„" value="í‚¤ì›Œë“œ ë¶„ì„">
            </div>

            <div class="input-group">
                <label>ë¸”ë¡œê·¸ URL:</label>
                <input type="text" id="blogUrl" placeholder="https://blog.naver.com/ì•„ì´ë””/ê¸€ë²ˆí˜¸">
            </div>

            <button onclick="testRanking()" id="testBtn">ìˆœìœ„ í™•ì¸í•˜ê¸°</button>
            <button onclick="clearResult()">ê²°ê³¼ ì§€ìš°ê¸°</button>

            <div id="result"></div>
        </div>

        <div class="warning">
            <strong>âš ï¸ ì£¼ì˜:</strong><br>
            1. Firebaseì— ë¡œê·¸ì¸ í•„ìš”<br>
            2. ì‹¤ì œ ë¸”ë¡œê·¸ URL ì…ë ¥<br>
            3. ë„¤ì´ë²„ê°€ ì°¨ë‹¨í•  ìˆ˜ ìˆìœ¼ë‹ˆ ê³¼ë„í•œ í…ŒìŠ¤íŠ¸ ìì œ<br>
            4. ê²°ê³¼ê°€ ë‚˜ì˜¤ë ¤ë©´ 5~10ì´ˆ ì†Œìš”
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFunctions, httpsCallable, connectFunctionsEmulator } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

        // Firebase ì„¤ì • (ì‹¤ì œ í”„ë¡œì íŠ¸: keyword-insight-pro)
        const firebaseConfig = {
            apiKey: "AIzaSyB9OTHfn8ys8kC_9TWikwQegLfb3oJuKpE",
            authDomain: "keyword-insight-pro.firebaseapp.com",
            projectId: "keyword-insight-pro",
            storageBucket: "keyword-insight-pro.appspot.com",
            messagingSenderId: "814882225550",
            appId: "1:814882225550:web:275de97363373b3f3eb8df"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'asia-northeast3');

        // ğŸ”§ ë¡œì»¬ Emulator ì‚¬ìš© (ë°°í¬ ì—†ì´ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥!)
        connectFunctionsEmulator(functions, 'localhost', 5001);

        // ì „ì—­ ë³€ìˆ˜ë¡œ ë…¸ì¶œ
        window.auth = auth;
        window.functions = functions;

        // ì¸ì¦ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        onAuthStateChanged(auth, (user) => {
            const statusEl = document.getElementById('authStatus');
            const userInfoEl = document.getElementById('userInfo');

            if (user) {
                statusEl.textContent = 'ë¡œê·¸ì¸ë¨';
                statusEl.className = 'status connected';
                userInfoEl.innerHTML = `<small>ì‚¬ìš©ì: ${user.email}</small>`;
                console.log('âœ… ë¡œê·¸ì¸ë¨:', user.email);
            } else {
                statusEl.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
                statusEl.className = 'status disconnected';
                userInfoEl.innerHTML = '';
                console.log('âŒ ë¡œê·¸ì¸ í•„ìš”');
            }
        });

        // í…ŒìŠ¤íŠ¸ ë¡œê·¸ì¸
        window.loginTest = async function() {
            const email = prompt('ì´ë©”ì¼:', 'admin@example.com');
            const password = prompt('ë¹„ë°€ë²ˆí˜¸:', 'admin123456');

            if (!email || !password) return;

            try {
                showResult('ë¡œê·¸ì¸ ì¤‘...', 'info');
                const userCredential = await signInWithEmailAndPassword(auth, email, password);

                // ì¸ì¦ ìƒíƒœê°€ ì™„ì „íˆ ì—…ë°ì´íŠ¸ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user && user.uid === userCredential.user.uid) {
                            unsubscribe();
                            resolve();
                        }
                    });
                });

                console.log('âœ… ë¡œê·¸ì¸ ì™„ë£Œ:', auth.currentUser?.email);
                showResult(`âœ… ë¡œê·¸ì¸ ì„±ê³µ!\nì‚¬ìš©ì: ${auth.currentUser?.email}`, 'success');
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                showResult(`âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // ë¡œê·¸ì•„ì›ƒ
        window.logout = async function() {
            try {
                await signOut(auth);
                showResult('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ', 'success');
            } catch (error) {
                showResult(`âŒ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        };

        // ë­í‚¹ í…ŒìŠ¤íŠ¸
        window.testRanking = async function() {
            const keyword = document.getElementById('keyword').value;
            const blogUrl = document.getElementById('blogUrl').value;
            const testBtn = document.getElementById('testBtn');

            if (!keyword || !blogUrl) {
                showResult('âŒ í‚¤ì›Œë“œì™€ ë¸”ë¡œê·¸ URLì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
                return;
            }

            // ì¸ì¦ ìƒíƒœ í™•ì¸ with ë””ë²„ê¹…
            console.log('ğŸ” ì¸ì¦ ìƒíƒœ í™•ì¸:', {
                currentUser: auth.currentUser,
                email: auth.currentUser?.email,
                uid: auth.currentUser?.uid
            });

            if (!auth.currentUser) {
                showResult('âŒ ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”!\n\nìœ„ì˜ "í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                testBtn.disabled = true;
                showResult('ğŸ” ìˆœìœ„ í™•ì¸ ì¤‘... (5~10ì´ˆ ì†Œìš”)\n\në„¤ì´ë²„ ê²€ìƒ‰ ì¤‘...', 'info');

                // Firebase Functions í˜¸ì¶œ
                const checkAllRankings = httpsCallable(functions, 'checkAllRankings');
                const result = await checkAllRankings({ keyword, targetUrl: blogUrl });

                const data = result.data;

                // ê²°ê³¼ í¬ë§·íŒ…
                let output = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                output += 'ğŸ“Š ë¸”ë¡œê·¸ ë­í‚¹ í™•ì¸ ê²°ê³¼\n';
                output += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';

                output += `ğŸ” ê²€ìƒ‰ í‚¤ì›Œë“œ: ${keyword}\n`;
                output += `ğŸ“ ë¸”ë¡œê·¸ URL: ${blogUrl}\n\n`;

                output += 'ã€í†µí•©ê²€ìƒ‰ - ìŠ¤ë§ˆíŠ¸ë¸”ë¡ã€‘\n';
                if (data.smartblock.found) {
                    output += `  âœ… ${data.smartblock.rank}ìœ„ ë°œê²¬!\n`;
                    output += `  ğŸ“Œ ì œëª©: ${data.smartblock.title || '(ì œëª© ì—†ìŒ)'}\n`;
                } else {
                    output += `  âŒ 10ìœ„ ë‚´ ìˆœìœ„ ì—†ìŒ\n`;
                }

                output += '\nã€í†µí•©ê²€ìƒ‰ - ë¸”ë¡œê·¸ ì˜ì—­ã€‘\n';
                if (data.mainBlog.found) {
                    output += `  âœ… ${data.mainBlog.rank}ìœ„ ë°œê²¬!\n`;
                    output += `  ğŸ“Œ ì œëª©: ${data.mainBlog.title || '(ì œëª© ì—†ìŒ)'}\n`;
                } else {
                    output += `  âŒ 30ìœ„ ë‚´ ìˆœìœ„ ì—†ìŒ\n`;
                }

                output += '\nã€ë¸”ë¡œê·¸ íƒ­ã€‘\n';
                if (data.blogTab.found) {
                    output += `  âœ… ${data.blogTab.rank}ìœ„ ë°œê²¬!\n`;
                    output += `  ğŸ“Œ ì œëª©: ${data.blogTab.title || '(ì œëª© ì—†ìŒ)'}\n`;
                } else {
                    output += `  âŒ 100ìœ„ ë‚´ ìˆœìœ„ ì—†ìŒ\n`;
                }

                output += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                output += `í™•ì¸ ì‹œê°: ${new Date().toLocaleString('ko-KR')}\n`;

                showResult(output, 'success');

            } catch (error) {
                console.error('Error:', error);
                let errorMsg = 'âŒ ì˜¤ë¥˜ ë°œìƒ:\n\n';

                if (error.code === 'unauthenticated') {
                    errorMsg += 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                } else if (error.code === 'invalid-argument') {
                    errorMsg += 'ì…ë ¥ê°’ì„ í™•ì¸í•˜ì„¸ìš”.';
                } else {
                    errorMsg += error.message || error.toString();
                }

                showResult(errorMsg, 'error');
            } finally {
                testBtn.disabled = false;
            }
        };

        // ê²°ê³¼ í‘œì‹œ
        function showResult(text, type) {
            const resultEl = document.getElementById('result');
            resultEl.textContent = text;
            resultEl.className = type || '';
        }

        window.clearResult = function() {
            document.getElementById('result').textContent = '';
        };

        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('ğŸ“ Functions ë¦¬ì „: asia-northeast3 (ì„œìš¸)');
    </script>
</body>
</html>
